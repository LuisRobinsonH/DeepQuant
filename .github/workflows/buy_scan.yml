# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  BUY SCAN â€” Corre UNA VEZ al dÃ­a, 15 minutos despuÃ©s de abrir ASX
#  ASX abre: 10:00 AEDT (UTC+11 Oct-Abr) = 23:00 UTC dÃ­a anterior
#             10:00 AEST (UTC+10 Abr-Oct) = 00:00 UTC mismo dÃ­a
#  â†’ Corre a las 23:15 UTC Dom-Jue (=10:15 AEDT Lun-Vie)
#     Y    a las 00:15 UTC Lun-Vie (=10:15 AEST Lun-Vie como backup)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: TitanBrain â€” Buy Scan Diario

on:
  schedule:
    - cron: '15 23 * * 0-4'   # 23:15 UTC Dom-Jue  = 10:15 AEDT Lun-Vie (verano AU)
    - cron: '15 0  * * 1-5'   # 00:15 UTC Lun-Vie  = 10:15 AEST Lun-Vie (invierno AU)
  workflow_dispatch:            # tambiÃ©n permite correrlo manualmente desde GitHub
    inputs:
      force:
        description: 'Forzar aunque sea fin de semana'
        type: boolean
        default: false

jobs:
  buy-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â”€â”€ 1. Descargar cÃ³digo (incluye portfolio state) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 2. Python 3.11 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # â”€â”€ 3. Cache de dependencias pip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('requirements_ci.txt') }}
          restore-keys: pip-

      - name: Instalar dependencias
        run: pip install -r requirements_ci.txt --quiet

      # â”€â”€ 4. Cache de modelos ML (se entrenan 1 vez por semana mÃ¡x) â”€
      - name: Calcular semana del aÃ±o
        run: echo "WEEK=$(date +%Y-W%V)" >> $GITHUB_ENV

      - name: Cache modelos ML
        id: cache-models
        uses: actions/cache@v4
        with:
          path: |
            models_cache.joblib
            features_cache.joblib
          key: models-${{ env.WEEK }}-${{ hashFiles('train_model_2021_2025.py') }}
          restore-keys: |
            models-
          
      - name: Entrenar modelos (solo si no hay cache)
        if: steps.cache-models.outputs.cache-hit != 'true'
        run: |
          echo "âš™ï¸  Cache miss â€” entrenando modelos (puede tardar 10-20min)..."
          python train_model_2021_2025.py

      # â”€â”€ 5. Ejecutar buy scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ejecutar Buy Scan
        env:
          TELEGRAM_TOKEN:   ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONIOENCODING: utf-8
        run: |
          FLAG=""
          if [ "${{ github.event.inputs.force }}" = "true" ]; then FLAG="--force"; fi
          python alerts_live.py scan $FLAG

      # â”€â”€ 6. Guardar estado del portfolio en el repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit portfolio state
        run: |
          git config user.name  "TitanBrain Bot"
          git config user.email "titanbot@noreply.github.com"
          git add current_portfolio.json trade_history.json 2>/dev/null || true
          git diff --staged --quiet || git commit -m "ğŸ“Š portfolio update $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push || true
